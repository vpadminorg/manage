import{d as O,r as y,w as U,e as q,o as F,c as J,j as v,k as w,x as _,n as D,I as Q,a3 as tt,v as et,K as ot,L as it,N as at}from"./index-_v2uieGc.js";import{c as lt,a as V,e as x,b as rt,V as B,E as st,d as nt,f as dt}from"./Viewer-CPM70ZwP.js";import{p as ht}from"./index-C9jLFToD.js";var ct=/^djs-cursor-.*$/;function A(t){var e=lt(document.body);e.removeMatching(ct),t&&e.add("djs-cursor-"+t)}function ut(){A(null)}var gt=5e3;function ft(t,e){e=e||"element.click";function l(){return!1}return t.once(e,gt,l),function(){t.off(e,l)}}function G(t,e){return{x:t.x-e.x,y:t.y-e.y}}function Z(t){return t.pointers&&t.pointers.length&&(t=t.pointers[0]),t.touches&&t.touches.length&&(t=t.touches[0]),t?{x:t.clientX,y:t.clientY}:null}var pt=15;function j(t,e){var l;t.on("element.mousedown",500,function(d){return c(d.originalEvent)});function r(d){var u=l.start,k=l.button,M=Z(d),b=G(M,u);if(!l.dragging&&mt(b)>pt&&(l.dragging=!0,k===0&&ft(t),A("grab")),l.dragging){var E=l.last||l.start;b=G(M,E),e.scroll({dx:b.x,dy:b.y}),l.last=M}d.preventDefault()}function h(d){x.unbind(document,"mousemove",r),x.unbind(document,"mouseup",h),l=null,ut()}function c(d){if(!V(d.target,".djs-draggable")){var u=d.button;if(!(u>=2||d.ctrlKey||d.shiftKey||d.altKey))return l={button:u,start:Z(d)},x.bind(document,"mousemove",r),x.bind(document,"mouseup",h),!0}}this.isActive=function(){return!!l}}j.$inject=["eventBus","canvas"];function mt(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))}const I={__init__:["moveCanvas"],moveCanvas:["type",j]};function L(t){return Math.log(t)/Math.log(10)}function H(t,e){var l=L(t.min),r=L(t.max),h=Math.abs(l)+Math.abs(r);return h/e}function vt(t,e){return Math.max(t.min,Math.min(t.max,e))}var _t=Math.sign||function(t){return t>=0?1:-1},z={min:.2,max:4},K=10,yt=.1,kt=.75;function m(t,e,l){t=t||{},this._enabled=!1,this._canvas=l,this._container=l._container,this._handleWheel=rt(this._handleWheel,this),this._totalDelta=0,this._scale=t.scale||kt;var r=this;e.on("canvas.init",function(h){r._init(t.enabled!==!1)})}m.$inject=["config.zoomScroll","eventBus","canvas"];m.prototype.scroll=function(e){this._canvas.scroll(e)};m.prototype.reset=function(){this._canvas.zoom("fit-viewport")};m.prototype.zoom=function(e,l){var r=H(z,K*2);this._totalDelta+=e,Math.abs(this._totalDelta)>yt&&(this._zoom(e,l,r),this._totalDelta=0)};m.prototype._handleWheel=function(e){if(!V(e.target,".djs-scrollable",!0)){var l=this._container;e.preventDefault();var r=e.ctrlKey,h=e.shiftKey,c=-1*this._scale,d;if(r?c*=e.deltaMode===0?.02:.32:c*=e.deltaMode===0?1:16,r){var u=l.getBoundingClientRect(),k={x:e.clientX-u.left,y:e.clientY-u.top};d=Math.sqrt(Math.pow(e.deltaY,2)+Math.pow(e.deltaX,2))*_t(e.deltaY)*c,this.zoom(d,k)}else h?d={dx:c*e.deltaY,dy:0}:d={dx:c*e.deltaX,dy:c*e.deltaY},this.scroll(d)}};m.prototype.stepZoom=function(e,l){var r=H(z,K);this._zoom(e,l,r)};m.prototype._zoom=function(t,e,l){var r=this._canvas,h=t>0?1:-1,c=L(r.zoom()),d=Math.round(c/l)*l;d+=l*h;var u=Math.pow(10,d);r.zoom(vt(z,u),e)};m.prototype.toggle=function(e){var l=this._container,r=this._handleWheel,h=this._enabled;return typeof e>"u"&&(e=!h),h!==e&&x[e?"bind":"unbind"](l,"wheel",r,!1),this._enabled=e,e};m.prototype._init=function(t){this.toggle(t)};const P={__init__:["zoomScroll"],zoomScroll:["type",m]},Mt=t=>(ot("data-v-e688fd06"),t=t(),it(),t),bt={class:"bpmnDialogContainers"},wt={class:"header-div"},xt=Mt(()=>_("div",null,[_("div",{class:"tips-label"},[_("div",{class:"un-complete"},"未完成"),_("div",{class:"in-progress"},"进行中"),_("div",{class:"complete"},"已完成")])],-1)),Et={class:"flow-containers"},Rt=O({__name:"index",setup(t,{expose:e}){const l=y(),r=y(),h=y([]),c=y(1),d=y(""),u=y(!1),k=y(!0),M=y([]),b=n=>{u.value=!0,k.value=!0,D(async()=>{r.value&&r.value.destroy(),r.value=new B({container:l.value,additionalModules:[{zoomScroll:["value",""]},P,I]});const o=await ht.getHistoryList(n);d.value=o.data.xml,h.value=o.data.taskList,M.value=o.data.historyList,await S(d.value),u.value=!1})},E=n=>{u.value=!0,k.value=!0,D(async()=>{r.value&&r.value.destroy(),r.value=new B({container:l.value,additionalModules:[{zoomScroll:["value",""]},P,I]}),d.value=n,await S(d.value),u.value=!1})},S=async n=>{try{await r.value.importXML(n),T(),W(),u.value=!1,Y()}catch(o){console.log(o)}},Y=()=>{const n=r.value.get("eventBus"),o=r.value.get("overlays");n.on("element.hover",i=>{let g=M.value.find(a=>a.taskDefinitionKey===i.element.id);i.element.type==="bpmn:UserTask"&&g&&setTimeout(()=>{N(i,o,g)},10)}),n.on("element.out",i=>{o.clear()})},N=(n,o,i)=>{o.add(n.element.id,{position:{top:n.element.height,left:0},html:`<div class="verlays">
                    <p>审批人员: ${i.nickName||""}<p/>
                    <p>节点状态：${i.status||""}</p>
                    <p>开始时间：${i.startTime||""}</p>
                    <p>结束时间：${i.endTime||""}</p>
                    <p>审批耗时：${i.runDuration||""}</p>
                    <p>流程版本：v${i.version||""}</p>
                   </div>`})},T=()=>{c.value=r.value.get("canvas").zoom("fit-viewport");const n=document.querySelector(".flow-containers .viewport").getBBox(),o=r.value.get("canvas").viewbox(),i={x:n.x+n.width/2-65,y:n.y+n.height/2};r.value.get("canvas").viewbox({x:i.x-o.width/2,y:i.y-o.height/2,width:o.width,height:o.height}),c.value=n.width/o.width*1.8},$=(n=!0)=>{c.value=r.value.get("canvas").zoom(),c.value+=n?.1:-.1,r.value.get("canvas").zoom(c.value)},W=()=>{const n=r.value.get("canvas");C(r.value._definitions.rootElements[0].flowElements,n)},C=(n,o)=>{n.forEach(i=>{var g;if(i.$type==="bpmn:UserTask"){const a=h.value.find(s=>s.key===i.id);a&&(o.addMarker(i.id,a.completed?"highlight":"highlight-todo"),(g=i.outgoing)==null||g.forEach(s=>{const p=h.value.find(f=>f.key===s.targetRef.id);p?o.addMarker(s.id,p.completed?"highlight":"highlight-todo"):s.targetRef.$type==="bpmn:ExclusiveGateway"?(o.addMarker(s.id,a.completed?"highlight":"highlight-todo"),o.addMarker(s.targetRef.id,a.completed?"highlight":"highlight-todo"),s.targetRef.outgoing.forEach(f=>{R(f.id,f.targetRef.$type,f.targetRef.id,o,a.completed)})):s.targetRef.$type==="bpmn:ParallelGateway"?(o.addMarker(s.id,a.completed?"highlight":"highlight-todo"),o.addMarker(s.targetRef.id,a.completed?"highlight":"highlight-todo"),s.targetRef.outgoing.forEach(f=>{R(f.id,f.targetRef.$type,f.targetRef.id,o,a.completed)})):s.targetRef.$type==="bpmn:InclusiveGateway"&&(o.addMarker(s.id,a.completed?"highlight":"highlight-todo"),o.addMarker(s.targetRef.id,a.completed?"highlight":"highlight-todo"),s.targetRef.outgoing.forEach(f=>{R(f.id,f.targetRef.$type,f.targetRef.id,o,a.completed)}))}))}else if(i.$type==="bpmn:ExclusiveGateway")i.outgoing.forEach(a=>{const s=h.value.find(p=>p.key===a.targetRef.id);s&&o.addMarker(a.id,s.completed?"highlight":"highlight-todo")});else if(i.$type==="bpmn:ParallelGateway")i.outgoing.forEach(a=>{const s=h.value.find(p=>p.key===a.targetRef.id);s&&o.addMarker(a.id,s.completed?"highlight":"highlight-todo")});else if(i.$type==="bpmn:InclusiveGateway")i.outgoing.forEach(a=>{const s=h.value.find(p=>p.key===a.targetRef.id);s&&o.addMarker(a.id,s.completed?"highlight":"highlight-todo")});else if(i.$type==="bpmn:SubProcess"){const a=h.value.find(s=>s.key===i.id);a&&o.addMarker(i.id,a.completed?"highlight":"highlight-todo"),C(i.flowElements,o)}else if(i.$type==="bpmn:StartEvent")o.addMarker(i.id,"startEvent"),i.outgoing&&i.outgoing.forEach(a=>{h.value.find(p=>p.key===a.targetRef.id)&&(o.addMarker(a.id,"highlight"),o.addMarker(i.id,"highlight"))});else if(i.$type==="bpmn:EndEvent"){o.addMarker(i.id,"endEvent");const a=h.value.find(s=>s.key===i.id);if(a){o.addMarker(a.key,"highlight"),o.addMarker(i.id,"highlight");return}}})},R=(n,o,i,g,a)=>{o==="bpmn:ExclusiveGateway"&&(g.addMarker(n,a?"highlight":"highlight-todo"),g.addMarker(i,a?"highlight":"highlight-todo")),o==="bpmn:ParallelGateway"&&(g.addMarker(n,a?"highlight":"highlight-todo"),g.addMarker(i,a?"highlight":"highlight-todo")),o==="bpmn:InclusiveGateway"&&(g.addMarker(n,a?"highlight":"highlight-todo"),g.addMarker(i,a?"highlight":"highlight-todo"))};return e({init:b,initXml:E}),(n,o)=>{const i=Q,g=tt,a=st,s=nt,p=dt,f=et;return U((F(),J("div",bt,[v(a,{style:{"border-bottom":"1px solid rgb(218 218 218)",height:"auto"}},{default:w(()=>[_("div",wt,[_("div",null,[v(g,{effect:"dark",content:"自适应屏幕",placement:"bottom"},{default:w(()=>[v(i,{size:"small",icon:"Rank",onClick:T})]),_:1}),v(g,{effect:"dark",content:"放大",placement:"bottom"},{default:w(()=>[v(i,{size:"small",icon:"ZoomIn",onClick:o[0]||(o[0]=X=>$(!0))})]),_:1}),v(g,{effect:"dark",content:"缩小",placement:"bottom"},{default:w(()=>[v(i,{size:"small",icon:"ZoomOut",onClick:o[1]||(o[1]=X=>$(!1))})]),_:1})]),xt])]),_:1}),_("div",Et,[v(p,{class:"bpmn-el-container",style:{"align-items":"stretch"}},{default:w(()=>[v(s,{style:{padding:"0"}},{default:w(()=>[_("div",{ref_key:"canvas",ref:l,class:"canvas"},null,512)]),_:1})]),_:1})])])),[[f,q(u)]])}}}),Tt=at(Rt,[["__scopeId","data-v-e688fd06"]]);export{Tt as B};
