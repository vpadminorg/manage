import{d as O,r as _,w as U,e as q,o as F,c as J,j as v,k as w,m as y,n as D,I as Q,a1 as tt,v as et,L as ot}from"./index-D4nD6lq3.js";import{c as it,a as A,e as x,b as at,V as B,E as lt,d as rt,f as st}from"./Viewer-DMA2S4ab.js";import{p as nt}from"./index-tWgKF5mO.js";var dt=/^djs-cursor-.*$/;function j(t){var e=it(document.body);e.removeMatching(dt),t&&e.add("djs-cursor-"+t)}function ht(){j(null)}var ct=5e3;function ut(t,e){e=e||"element.click";function l(){return!1}return t.once(e,ct,l),function(){t.off(e,l)}}function G(t,e){return{x:t.x-e.x,y:t.y-e.y}}function Z(t){return t.pointers&&t.pointers.length&&(t=t.pointers[0]),t.touches&&t.touches.length&&(t=t.touches[0]),t?{x:t.clientX,y:t.clientY}:null}var gt=15;function H(t,e){var l;t.on("element.mousedown",500,function(d){return c(d.originalEvent)});function r(d){var u=l.start,k=l.button,M=Z(d),b=G(M,u);if(!l.dragging&&ft(b)>gt&&(l.dragging=!0,k===0&&ut(t),j("grab")),l.dragging){var E=l.last||l.start;b=G(M,E),e.scroll({dx:b.x,dy:b.y}),l.last=M}d.preventDefault()}function h(d){x.unbind(document,"mousemove",r),x.unbind(document,"mouseup",h),l=null,ht()}function c(d){if(!A(d.target,".djs-draggable")){var u=d.button;if(!(u>=2||d.ctrlKey||d.shiftKey||d.altKey))return l={button:u,start:Z(d)},x.bind(document,"mousemove",r),x.bind(document,"mouseup",h),!0}}this.isActive=function(){return!!l}}H.$inject=["eventBus","canvas"];function ft(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))}const P={__init__:["moveCanvas"],moveCanvas:["type",H]};function L(t){return Math.log(t)/Math.log(10)}function Y(t,e){var l=L(t.min),r=L(t.max),h=Math.abs(l)+Math.abs(r);return h/e}function mt(t,e){return Math.max(t.min,Math.min(t.max,e))}var pt=Math.sign||function(t){return t>=0?1:-1},z={min:.2,max:4},I=10,vt=.1,yt=.75;function p(t,e,l){t=t||{},this._enabled=!1,this._canvas=l,this._container=l._container,this._handleWheel=at(this._handleWheel,this),this._totalDelta=0,this._scale=t.scale||yt;var r=this;e.on("canvas.init",function(h){r._init(t.enabled!==!1)})}p.$inject=["config.zoomScroll","eventBus","canvas"];p.prototype.scroll=function(e){this._canvas.scroll(e)};p.prototype.reset=function(){this._canvas.zoom("fit-viewport")};p.prototype.zoom=function(e,l){var r=Y(z,I*2);this._totalDelta+=e,Math.abs(this._totalDelta)>vt&&(this._zoom(e,l,r),this._totalDelta=0)};p.prototype._handleWheel=function(e){if(!A(e.target,".djs-scrollable",!0)){var l=this._container;e.preventDefault();var r=e.ctrlKey,h=e.shiftKey,c=-1*this._scale,d;if(r?c*=e.deltaMode===0?.02:.32:c*=e.deltaMode===0?1:16,r){var u=l.getBoundingClientRect(),k={x:e.clientX-u.left,y:e.clientY-u.top};d=Math.sqrt(Math.pow(e.deltaY,2)+Math.pow(e.deltaX,2))*pt(e.deltaY)*c,this.zoom(d,k)}else h?d={dx:c*e.deltaY,dy:0}:d={dx:c*e.deltaX,dy:c*e.deltaY},this.scroll(d)}};p.prototype.stepZoom=function(e,l){var r=Y(z,I);this._zoom(e,l,r)};p.prototype._zoom=function(t,e,l){var r=this._canvas,h=t>0?1:-1,c=L(r.zoom()),d=Math.round(c/l)*l;d+=l*h;var u=Math.pow(10,d);r.zoom(mt(z,u),e)};p.prototype.toggle=function(e){var l=this._container,r=this._handleWheel,h=this._enabled;return typeof e>"u"&&(e=!h),h!==e&&x[e?"bind":"unbind"](l,"wheel",r,!1),this._enabled=e,e};p.prototype._init=function(t){this.toggle(t)};const V={__init__:["zoomScroll"],zoomScroll:["type",p]},_t={class:"bpmnDialogContainers"},kt={class:"header-div"},Mt={class:"flow-containers"},bt=O({__name:"index",setup(t,{expose:e}){const l=_(),r=_(),h=_([]),c=_(1),d=_(""),u=_(!1),k=_(!0),M=_([]),b=n=>{u.value=!0,k.value=!0,D(async()=>{r.value&&r.value.destroy(),r.value=new B({container:l.value,additionalModules:[{zoomScroll:["value",""]},V,P]});const o=await nt.getHistoryList(n);d.value=o.data.xml,h.value=o.data.taskList,M.value=o.data.historyList,await T(d.value),u.value=!1})},E=n=>{u.value=!0,k.value=!0,D(async()=>{r.value&&r.value.destroy(),r.value=new B({container:l.value,additionalModules:[{zoomScroll:["value",""]},V,P]}),d.value=n,await T(d.value),u.value=!1})},T=async n=>{try{await r.value.importXML(n),$(),X(),u.value=!1,K()}catch(o){console.log(o)}},K=()=>{const n=r.value.get("eventBus"),o=r.value.get("overlays");n.on("element.hover",i=>{let g=M.value.find(a=>a.taskDefinitionKey===i.element.id);i.element.type==="bpmn:UserTask"&&g&&setTimeout(()=>{W(i,o,g)},10)}),n.on("element.out",i=>{o.clear()})},W=(n,o,i)=>{o.add(n.element.id,{position:{top:n.element.height,left:0},html:`<div class="verlays">
                    <p>审批人员: ${i.nickName||""}<p/>
                    <p>节点状态：${i.status||""}</p>
                    <p>开始时间：${i.startTime||""}</p>
                    <p>结束时间：${i.endTime||""}</p>
                    <p>审批耗时：${i.runDuration||""}</p>
                    <p>流程版本：v${i.version||""}</p>
                   </div>`})},$=()=>{c.value=r.value.get("canvas").zoom("fit-viewport");const n=document.querySelector(".flow-containers .viewport").getBBox(),o=r.value.get("canvas").viewbox(),i={x:n.x+n.width/2-65,y:n.y+n.height/2};r.value.get("canvas").viewbox({x:i.x-o.width/2,y:i.y-o.height/2,width:o.width,height:o.height}),c.value=n.width/o.width*1.8},S=(n=!0)=>{c.value=r.value.get("canvas").zoom(),c.value+=n?.1:-.1,r.value.get("canvas").zoom(c.value)},X=()=>{const n=r.value.get("canvas");C(r.value._definitions.rootElements[0].flowElements,n)},C=(n,o)=>{n.forEach(i=>{var g;if(i.$type==="bpmn:UserTask"){const a=h.value.find(s=>s.key===i.id);a&&(o.addMarker(i.id,a.completed?"highlight":"highlight-todo"),(g=i.outgoing)==null||g.forEach(s=>{const m=h.value.find(f=>f.key===s.targetRef.id);m?o.addMarker(s.id,m.completed?"highlight":"highlight-todo"):s.targetRef.$type==="bpmn:ExclusiveGateway"?(o.addMarker(s.id,a.completed?"highlight":"highlight-todo"),o.addMarker(s.targetRef.id,a.completed?"highlight":"highlight-todo"),s.targetRef.outgoing.forEach(f=>{R(f.id,f.targetRef.$type,f.targetRef.id,o,a.completed)})):s.targetRef.$type==="bpmn:ParallelGateway"?(o.addMarker(s.id,a.completed?"highlight":"highlight-todo"),o.addMarker(s.targetRef.id,a.completed?"highlight":"highlight-todo"),s.targetRef.outgoing.forEach(f=>{R(f.id,f.targetRef.$type,f.targetRef.id,o,a.completed)})):s.targetRef.$type==="bpmn:InclusiveGateway"&&(o.addMarker(s.id,a.completed?"highlight":"highlight-todo"),o.addMarker(s.targetRef.id,a.completed?"highlight":"highlight-todo"),s.targetRef.outgoing.forEach(f=>{R(f.id,f.targetRef.$type,f.targetRef.id,o,a.completed)}))}))}else if(i.$type==="bpmn:ExclusiveGateway")i.outgoing.forEach(a=>{const s=h.value.find(m=>m.key===a.targetRef.id);s&&o.addMarker(a.id,s.completed?"highlight":"highlight-todo")});else if(i.$type==="bpmn:ParallelGateway")i.outgoing.forEach(a=>{const s=h.value.find(m=>m.key===a.targetRef.id);s&&o.addMarker(a.id,s.completed?"highlight":"highlight-todo")});else if(i.$type==="bpmn:InclusiveGateway")i.outgoing.forEach(a=>{const s=h.value.find(m=>m.key===a.targetRef.id);s&&o.addMarker(a.id,s.completed?"highlight":"highlight-todo")});else if(i.$type==="bpmn:SubProcess"){const a=h.value.find(s=>s.key===i.id);a&&o.addMarker(i.id,a.completed?"highlight":"highlight-todo"),C(i.flowElements,o)}else if(i.$type==="bpmn:StartEvent")o.addMarker(i.id,"startEvent"),i.outgoing&&i.outgoing.forEach(a=>{h.value.find(m=>m.key===a.targetRef.id)&&(o.addMarker(a.id,"highlight"),o.addMarker(i.id,"highlight"))});else if(i.$type==="bpmn:EndEvent"){o.addMarker(i.id,"endEvent");const a=h.value.find(s=>s.key===i.id);if(a){o.addMarker(a.key,"highlight"),o.addMarker(i.id,"highlight");return}}})},R=(n,o,i,g,a)=>{o==="bpmn:ExclusiveGateway"&&(g.addMarker(n,a?"highlight":"highlight-todo"),g.addMarker(i,a?"highlight":"highlight-todo")),o==="bpmn:ParallelGateway"&&(g.addMarker(n,a?"highlight":"highlight-todo"),g.addMarker(i,a?"highlight":"highlight-todo")),o==="bpmn:InclusiveGateway"&&(g.addMarker(n,a?"highlight":"highlight-todo"),g.addMarker(i,a?"highlight":"highlight-todo"))};return e({init:b,initXml:E}),(n,o)=>{const i=Q,g=tt,a=lt,s=rt,m=st,f=et;return U((F(),J("div",_t,[v(a,{style:{"border-bottom":"1px solid rgb(218 218 218)",height:"auto"}},{default:w(()=>[y("div",kt,[y("div",null,[v(g,{effect:"dark",content:"自适应屏幕",placement:"bottom"},{default:w(()=>[v(i,{size:"small",icon:"Rank",onClick:$})]),_:1}),v(g,{effect:"dark",content:"放大",placement:"bottom"},{default:w(()=>[v(i,{size:"small",icon:"ZoomIn",onClick:o[0]||(o[0]=N=>S(!0))})]),_:1}),v(g,{effect:"dark",content:"缩小",placement:"bottom"},{default:w(()=>[v(i,{size:"small",icon:"ZoomOut",onClick:o[1]||(o[1]=N=>S(!1))})]),_:1})]),o[2]||(o[2]=y("div",null,[y("div",{class:"tips-label"},[y("div",{class:"un-complete"},"未完成"),y("div",{class:"in-progress"},"进行中"),y("div",{class:"complete"},"已完成")])],-1))])]),_:1}),y("div",Mt,[v(m,{class:"bpmn-el-container",style:{"align-items":"stretch"}},{default:w(()=>[v(s,{style:{padding:"0"}},{default:w(()=>[y("div",{ref_key:"canvas",ref:l,class:"canvas"},null,512)]),_:1})]),_:1})])])),[[f,q(u)]])}}}),Rt=ot(bt,[["__scopeId","data-v-e688fd06"]]);export{Rt as B};
